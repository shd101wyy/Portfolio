// global variable
var FILE_LIST_POINTER, FILE_LIST_DATA;

/**
 *
 *
 * folder {
 * 		name:
 * 		kind:
 * 		size:
 * 		commit_revision:
 * 		commit_author:
 * 		commit_date
 * 		parent:
 * 		children: {
 * 			test: {
 * 					name:
 * 					kind:
 * 					size:
 * 					commit_revision:
 * 					commit_author
 * 					commit_date:
 * 					parent:
 * 				  }
 *
 * 		}
 * }
 *
 */
function File (info){
    this.name = info.name;
    this.kind = info.kind;
    this.size = info.size;
    this.commit_revision = info.commit_revision;
    this.commit_author = info.commit_author;
    this.commit_date = info.commit_date;
    this.parent = info.parent;
    this.single_name = info.single_name;
    this.files = {};
}
/**
 * Clean the JSON file that is generated by xml2js
 */
function cleanListJSON(list_json){
    /**
     * Output is in format of
     * {
     *     name:
     *     kind:
     *     size:
     *     commit_revision:
     *     commit_author:
     *     commit_date:
     *     parent:    get parent folder
     *     children:  if it is dir, recursively list all children
     * }
     */
    var home_directory = new File({
        name: ".",
        kind: "dir",
        size: "undefined",
        commit_revision: "undefined",
        commit_author: "undefined",
        commit_date: "undefined",
        parent: null
    });
    list_json = list_json.lists.list[0].entry;
    /**
     * Right now each element in list_json looks like
     * {
        "$":{
           "kind":"dir"
        },
        "name":[
           "Assignment0"
        ],
        "commit":[
           {
              "$":{
                 "revision":"478"
              },
              "author":[
                 "ywang189"
              ],
              "date":[
                 "2015-02-06T02:50:23.452896Z"
              ]
           }
        ]
     }
     *
     */
    for(var i = 0; i < list_json.length; i++){
        var element = list_json[i];
        var info = {
                kind: element.$.kind,
                name: element.name[0],
                // commit: element.commit[0],
                size: (element.$.kind == "file" ? element.size[0] : "undefined"),
                commit_revision: element.commit[0].$.revision,
                commit_author: element.commit[0].author[0],
                commit_date: element.commit[0].date[0]
        };
        // split file name
        var file_name_arr = element.name[0].split("/");
        var current_folder = home_directory;
        for(var j = 0; j < file_name_arr.length; j++){
            if (file_name_arr[j] in current_folder.files){ // go to subfolder
                current_folder = current_folder.files[file_name_arr[j]];
            }
            else{
                var new_file = new File( info );
                new_file.parent = current_folder;
                new_file.single_name = file_name_arr[j];
                current_folder.files[new_file.single_name] = new_file; // add to directory
            }
        }
    }
    return home_directory;
}

/**
 * file_info
 *  {
 *     name:
 *     kind:
 *     size:
 *     commit_revision:
 *     commit_author:
 *     commit_date:
 *     parent:    get parent folder
 *     children:  if it is dir, recursively list all children
 * }
 *
 */
function generateDivObjectForFile(file_info){
    var file_div = $("<div></div>");
    if (file_info.kind === "dir"){ // directory
        file_div.addClass("tile bg-amber");
        file_div.append('<div class="tile-content icon"><i class="icon-folder-2"></i></div>'); // add icon
    }
    else{ // file
        file_div.addClass("tile bg-cyan");
    }
    var file_brand = $("<div></div>").addClass("brand bg-dark opacity");
    var file_name = $("<span></span>").addClass("text").text(file_info.single_name);
    file_div.attr({data: file_info}); // save data

    file_brand.append(file_name);
    file_div.append(file_brand);

    // user click directory
    if (file_info.kind === "dir"){ // directory
        // bind click function
        file_div.click(function(){
            generateFileList(file_info);
        });
    }
    return file_div;
}

/*
 * create back tile
 */
function createBackTile(parent){
    if (parent === "." || parent === null) return "";
    var back_div = $("<div></div>").addClass("tile bg-darkRed");
    var back_brand = $("<div></div>").addClass("brand bg-dark opacity");
    var back_name = $("<span></span>").addClass("text").text("back");

    back_brand.append(back_name);
    back_div.append(back_brand);

    // bind click function
    back_div.click(function(){
        generateFileList(parent);
    });
    $("#files_view").append(back_div);
    return back_div;
}

/**
 * Generate file list tree
 * tree id: file_list_tree
 *
 * <div class="tile bg-cyan">
     <div class="brand bg-dark opacity">
         <span class="text">
             Hello
         </span>
     </div>
 </div>
 */
 function generateFileList(file_data){
     // clear files_view
     $("#files_view").html("");

     // create back tile
     createBackTile(file_data.parent);

     // draw children files/directories
     var file_info = null;
     var children = file_data.files;
     for(var file_name in children){
         file_info = children[file_name];
         $("#files_view").append(generateDivObjectForFile(file_info));
     }
 }
