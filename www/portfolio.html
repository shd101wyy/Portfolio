<html>
    <head>
        <title>Portfolio</title>
        <meta charset="utf-8">
        <meta name="author" content="Yiyi Wang ywang189">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="css/metro-bootstrap.min.css">
        <link rel="stylesheet" href="css/metro-bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/iconFont.min.css">
        <link rel="stylesheet" href="css/portfolio.css">
        <link rel="stylesheet" href="http://css-spinners.com/css/spinner/ball.css" type="text/css">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.8/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.8/ext-modelist.js" type="text/javascript" charset="utf-8"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery.widget.min.js"></script>
        <script src="js/metro.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
        <script src="js/formatLog.js"></script>
        <script src="js/formatList.js"></script>
        <script src="js/filesViewController.js"></script>

    </head>
    <body class="metro">
        <nav class="navigation-bar dark">
            <nav class="navigation-bar-content">
                <item class="element" id="user_name_header"> Hi, User</span></item>
                <item class="element-divider"></item>
                <item class="element" id="user_svn_address"> This is address </item>
                <button class="element place-right" id="logout_btn">
                    Logout
                </button>
            </nav>
        </nav>

        <div id = "main_panel">
            <!-- Files View
                Show file list -->
            <div id="files_view_container">
                <div id="files_view">
                </div>
            </div>
            <!-- File Informatino
            -->
            <div id="file_information_container">
                <div id="file_information">
                    <h3 id="info_name">Name </h3> <br>
                    <p id="info_path">Path</p>
                    <p id="info_kind">Kind </p>
                    <p id="info_size">Size</p>
                    <p id="info_commit_revision">Commit Revision</p>
                    <p id="info_commit_author">Commit Author</p>
                    <p id="info_commit_date">Commit Date</p>
                    <p id="info_commit_msg">Commit Message</p>
                </div>
                <ul id="commit_list">
                </ul>
            </div>
        </div>
    </body>
    <script>
        var socket;  // global variable socket.
        var user_id; // global variable user id
        var user_name; // global variable user name
        var LOG;     // gloabl variable LOG
        $(document).ready(function(){
            /**
             * Parse URL parameters and return a JSON data
             */
            function parseURLParameters() {
                  var query = window.location.search.substring(1);
                  var vars = query.split("&");
                  var output = {};
                  for (var i=0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    output[pair[0]] = pair[1];
                  }
                  return output;
            }
            /**
             * shwo file list
             * @data is in format like
             * user_data[socket.id ] = {
                 user_name: user_name,
                 user_password: user_password,
                 user_svn_address: user_svn_address,
                 log_json: log_json,
                 list_json: list_json
             };
             */
            function initFileList(data){
                var user_name = data.user_name;
                var user_svn_address = data.user_svn_address;
                var log_json = data.log_json;
                var list_json = data.list_json;
                $("#user_svn_address").text(user_svn_address); // show subversion address

                var log_data = cleanLogJSON(log_json); // clean log data
                LOG = log_data;

                var file_list_data = cleanListJSON(list_json, user_name, LOG); // clean list data;
                generateFileList(file_list_data); // generate file list tree;
            }


            socket = io(); // initialize socketio.
            var data = parseURLParameters();
            user_name = data.user_name;
            user_id = data.socket_id;
            $("#user_name_header").text("Hi,  " + user_name);

            socket.emit("get_data", user_id); // get log/list data from server.

            socket.on("get_data_success", function(data){
                initFileList(data);
            });

            /**
             * Logout
             * TODO: delete user id from data base
             */
            $("#logout_btn").click(function(){
                window.location.href = "./index.html";
            });
        });
    </script>
</html>
