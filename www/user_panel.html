<html>
    <head>
        <title>Portfolio User Panel</title>
        <meta charset="utf-8">
        <meta name="author" content="Yiyi Wang ywang189">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="css/metro-bootstrap.min.css">
        <link rel="stylesheet" href="css/metro-bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/iconFont.min.css">
        <link rel="stylesheet" href="css/user_panel.css">
        <link rel="stylesheet" href="css/smoke.css">


        <script src="js/jquery.min.js"></script>
        <script src="js/jquery.widget.min.js"></script>
        <script src="js/metro.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.3.0/bootbox.min.js"></script>
        <script src="js/smoke.js"> </script>
    </head>
    <body class="metro">
        <nav class="navigation-bar dark">
            <nav class="navigation-bar-content">
                <item class="element" id="user_name_header"> Hi, User</span></item>
                <item class="element-divider"></item>
                <button class="element place-right" id="logout_btn">
                    Logout
                </button>
            </nav>
        </nav>
        <div id="main_panel">
            <div id="friend_lists_div">
                <h2> Friends List </h2>
                <div id="friend_lists" class="listview">
                    <a href="#" class="list">
                        <div class="list-content">
                            <p> shd101wyy </p>
                        </div>
                    </a>
                </div>
                <div>
                    <button id="add_friend_btn">
                        Add Friend
                    </button>
                </div>
            </div>
        </div>
    </body>
    <script>
        var socket;  // global variable socket.
        var user_id; // global variable user id
        var user_name; // global variable user name
        var LOG;     // gloabl variable LOG
        $(document).ready(function(){
            /**
             * Parse URL parameters and return a JSON data
             */
            function parseURLParameters() {
                  var query = window.location.search.substring(1);
                  var vars = query.split("&");
                  var output = {};
                  for (var i=0; i < vars.length; i++) {
                    var pair = vars[i].split("=");
                    output[pair[0]] = pair[1];
                  }
                  return output;
            }

            socket = io(); // initialize socketio.
            var data = parseURLParameters();
            user_name = data.user_name;
            user_id = data.id;
            $("#user_name_header").text("Hi,  " + user_name);

            // tell user we are now in user_panel
            socket.emit("user_in_panel_page", [user_name, user_id]);

            // receive user data from server
            socket.on("receive_user_data_from_server", function(user_data){
                var friend_lists = $("#friend_lists");
                var friends = user_data.friends;
                /*
                <a href="#" class="list">
                    <div class="list-content">
                        <p> shd101wyy </p>
                    </div>
                </a>
                 */
                for(var i = 0; i < friends.length; i++){
                    var f = $("<a></a>").class("list");
                    var d = $("<div></div>").class("list-content");
                    var content = "<p>" + friends[i] + "</p>";
                    d.html(content);
                    f.append(d);
                    friends.append(f);
                }
            });

            // click add friend button
            // add friend
            $("#add_friend_btn").click(function(){
                smoke.prompt("Enter your friend's user name here", function(friend_user_name){
                    socket.emit("add_friend", friend_user_name); // send request to server
                }, {
                    ok: "Add",
                    cancel: "No",
                    reverseButtons: true
                });
            });

            socket.on("no_such_user", function(friend_user_name){
                var not = $.Notify({
                    caption: "Info",
                    content: "User " + friend_user_name + " doesn't exist.",
                    style: {background: "#a7604a", color: "white"},
                    timeout: 5000 // 5 seconds
                });
            });

            //
            socket.on("friend_request_failed", function(data){
                var not = $.Notify({
                    caption: "Failed to send friend request",
                    content: data,
                    style: {background: "#a7604a", color: "white"},
                    timeout: 5000 // 5 seconds
                });
            });

            // add friend request sent
            socket.on("add_friend_request_sent", function(friend_user_name){
                var not = $.Notify({
                    caption: "Info",
                    content: "Friend request sent to " + friend_user_name,
                    style: {background: "#3e8fc5", color: "white"},
                    timeout: 5000 // 5 seconds
                });
            });

            // receive friend request from friend
            socket.on("receive_friend_request", function(friend_user_name){
                smoke.confirm(friend_user_name + " wants to add you as friend! ", function(e){
                    if(e){ // accept
                        socket.emit("accept_friend_request", [user_name, friend_user_name]);
                    }
                }, {
                    ok: "Accept",
                    cancel: "Reject",
                    reverseButtons: true
                });
            });


            /**
             * Logout
             * TODO: delete user id from data base
             */
            $("#logout_btn").click(function(){
                window.location.href = "./index.html";
            });
        });
    </script>
</html>
